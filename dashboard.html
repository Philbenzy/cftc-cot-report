<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CFTC COT Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #D4AF37;
      --gold-dark: #B8952F;
      --bg-primary: #0d0d0d;
      --bg-card: #252525;
      --bg-card-hover: #2d2d2d;
      --border: #333;
      --text: #fff;
      --text-muted: #888;
      --green: #22c55e;
      --red: #ef4444;
      --blue: #3b82f6;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary);
      color: var(--text);
      line-height: 1.6;
      padding: 24px;
    }

    /* 控制栏 */
    .controls {
      display: flex;
      gap: 24px;
      margin-bottom: 24px;
      flex-wrap: wrap;
      align-items: center;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .control-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .select-wrapper { position: relative; }
    select {
      appearance: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      padding: 10px 36px 10px 14px;
      font-family: inherit;
      font-size: 14px;
      cursor: pointer;
      min-width: 180px;
    }
    select:hover { border-color: var(--gold-dark); }
    select:focus { outline: none; border-color: var(--gold); }
    .select-wrapper::after {
      content: '▼';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 10px;
      pointer-events: none;
    }

    .time-buttons { display: flex; gap: 8px; }
    .time-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      padding: 10px 20px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .time-btn:hover { border-color: var(--gold-dark); color: var(--text); }
    .time-btn.active { background: var(--gold); border-color: var(--gold); color: #000; font-weight: 600; }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .title { font-size: 24px; font-weight: 600; color: var(--gold); }
    .subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
    .update-time { font-size: 12px; color: var(--text-muted); text-align: right; }

    /* Metrics */
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .metric-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.2s;
    }
    .metric-card:hover { background: var(--bg-card-hover); border-color: var(--gold-dark); }
    .metric-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
    .metric-value { font-size: 26px; font-weight: 700; }
    .metric-value.positive { color: var(--green); }
    .metric-value.negative { color: var(--red); }
    .metric-change { font-size: 12px; margin-top: 8px; }
    .metric-change.positive { color: var(--green); }
    .metric-change.negative { color: var(--red); }

    /* Charts */
    .charts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }
    @media (max-width: 1200px) { .charts { grid-template-columns: 1fr; } }
    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }
    .chart-card.full { grid-column: span 2; }
    @media (max-width: 1200px) { .chart-card.full { grid-column: span 1; } }
    .chart-title { font-size: 14px; font-weight: 600; color: var(--gold); margin-bottom: 16px; }
    .chart-subtitle { font-size: 11px; color: var(--text-muted); margin-top: -12px; margin-bottom: 16px; }
    .chart-container { height: 260px; position: relative; }
    .chart-container.tall { height: 320px; }

    /* Table */
    .table-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      overflow-x: auto;
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th {
      text-align: left;
      padding: 12px 16px;
      background: var(--bg-primary);
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      font-size: 11px;
      border-bottom: 1px solid var(--border);
    }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--bg-card-hover); }
    .num { text-align: right; font-family: 'JetBrains Mono', monospace; }
    .pos { color: var(--green); }
    .neg { color: var(--red); }
  </style>
</head>
<body>
  <!-- 控制栏 -->
  <div class="controls">
    <div class="control-group">
      <span class="control-label">品种</span>
      <div class="select-wrapper">
        <select id="commoditySelect"></select>
      </div>
    </div>
    <div class="control-group">
      <span class="control-label">时间范围</span>
      <div class="time-buttons">
        <button class="time-btn" data-weeks="13">3个月</button>
        <button class="time-btn" data-weeks="26">6个月</button>
        <button class="time-btn active" data-weeks="52">1年</button>
        <button class="time-btn" data-weeks="156">3年</button>
      </div>
    </div>
  </div>

  <header class="header">
    <div>
      <h1 class="title" id="pageTitle">CFTC COT Report</h1>
      <p class="subtitle" id="pageSubtitle">Commitments of Traders</p>
    </div>
    <div class="update-time" id="updateTime"></div>
  </header>

  <div class="metrics" id="metrics"></div>

  <div class="charts">
    <!-- 净持仓趋势 + 边际变化组合图 -->
    <div class="chart-card full">
      <div class="chart-title" id="title-combo">净持仓趋势与边际变化</div>
      <div class="chart-subtitle">折线：净持仓水平 | 柱状：周度变化量（右轴）</div>
      <div class="chart-container tall"><canvas id="comboChart"></canvas></div>
    </div>

    <!-- Other Reportable 增减 -->
    <div class="chart-card full">
      <div class="chart-title" id="title-change">Other Reportable 持仓周度变化</div>
      <div class="chart-subtitle">绿色增仓 / 红色减仓 | 虚线为均值 | Other Reportable = 除 Managed Money、生产商、Swap Dealer 以外的机构</div>
      <div class="chart-container"><canvas id="changeChart"></canvas></div>
    </div>

    <div class="chart-card">
      <div class="chart-title" id="title-oi">未平仓合约量</div>
      <div class="chart-container"><canvas id="oiChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title" id="title-compare">多空持仓对比（近12周）</div>
      <div class="chart-container"><canvas id="compareChart"></canvas></div>
    </div>

    <!-- GVZ 图表：仅黄金品种显示 -->
    <div class="chart-card full gold-only" id="gvzComboCard" style="display:none">
      <div class="chart-title" id="title-gvz-combo">GVZ 波动率 vs 非商业净持仓</div>
      <div class="chart-subtitle">GVZ 上升 = 市场恐慌 | 观察波动率与投机持仓的背离关系</div>
      <div class="chart-container tall"><canvas id="gvzComboChart"></canvas></div>
    </div>
    <div class="chart-card full gold-only" id="gvzCard" style="display:none">
      <div class="chart-title" id="title-gvz">GVZ 黄金波动率指数</div>
      <div class="chart-subtitle">紫线：GVZ（左轴） | 金柱：GLD 周成交量（右轴） | 灰色虚线为均值</div>
      <div class="chart-container"><canvas id="gvzChart"></canvas></div>
    </div>
  </div>

  <div class="table-card">
    <div class="chart-title" id="title-table">周度持仓变化明细</div>
    <table id="dataTable"></table>
  </div>

  <script>
    let ALL_DATA = null;
    let currentCommodity = 'gold';
    let currentWeeks = 52;
    let charts = {};

    const fmt = n => n == null ? '-' : n.toLocaleString();
    const fmtChg = n => n == null ? '-' : (n > 0 ? '+' : '') + n.toLocaleString();
    const fmtAxis = v => Math.abs(v) >= 1e6 ? (v/1e6).toFixed(1)+'M' : Math.abs(v) >= 1e3 ? (v/1e3).toFixed(0)+'K' : v;
    const fmtPct = n => n == null ? '-' : (n > 0 ? '+' : '') + n.toFixed(1) + '%';

    Chart.defaults.color = '#888';
    Chart.defaults.borderColor = '#333';
    Chart.defaults.font.family = "'JetBrains Mono', monospace";

    async function loadData() {
      try {
        const res = await fetch('./data/cot_data.json');
        if (res.ok) ALL_DATA = await res.json();
        else throw new Error('Failed');
      } catch (e) {
        console.error('使用内置数据', e);
        ALL_DATA = FALLBACK_DATA;
      }
      initUI();
      render();
    }

    function initUI() {
      const select = document.getElementById('commoditySelect');
      select.innerHTML = ALL_DATA.commodity_list.map(c =>
        `<option value="${c.code}">${c.name} (${c.name_en})</option>`
      ).join('');
      select.value = currentCommodity;
      select.addEventListener('change', e => { currentCommodity = e.target.value; render(); });

      document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentWeeks = parseInt(btn.dataset.weeks);
          render();
        });
      });
    }

    function getCurrentData() {
      const commodity = ALL_DATA.commodities[currentCommodity];
      if (!commodity) return null;

      const weekly = commodity.weekly_data.slice(-currentWeeks);
      const latest = weekly[weekly.length - 1];

      // 计算变化率
      const prev = weekly.length > 1 ? weekly[weekly.length - 2] : latest;
      const mmPctChg   = prev.mm_net   !== 0 ? ((latest.mm_net   - prev.mm_net)   / Math.abs(prev.mm_net))   * 100 : 0;
      const prodPctChg = prev.prod_net !== 0 ? ((latest.prod_net - prev.prod_net) / Math.abs(prev.prod_net)) * 100 : 0;

      const summary = {
        latest_date: latest.date,
        mm_net:   latest.mm_net,
        prod_net: latest.prod_net,
        open_interest: latest.open_interest,
        mm_net_change:   latest.mm_net_change,
        prod_net_change: latest.prod_net_change,
        oi_change: latest.oi_change,
        long_short_ratio: (latest.mm_long / Math.max(latest.mm_short, 1)).toFixed(2),
        mm_pct_change:   mmPctChg,
        prod_pct_change: prodPctChg
      };

      return { name: commodity.name, name_en: commodity.name_en, summary, weekly_data: weekly };
    }

    function render() {
      const data = getCurrentData();
      if (!data) return;
      renderHeader(data);
      renderMetrics(data.summary);
      renderCharts(data.weekly_data);
      renderGVZ(data.weekly_data);
      renderTable(data.weekly_data);
    }

    function renderHeader(data) {
      document.getElementById('pageTitle').textContent = `CFTC COT Report - ${data.name_en}`;
      const timeText = currentWeeks === 13 ? '3个月' : currentWeeks === 26 ? '6个月' : currentWeeks === 52 ? '1年' : '3年';
      document.getElementById('pageSubtitle').textContent = `Commitments of Traders | 近${timeText}持仓数据分析`;
      document.getElementById('updateTime').innerHTML = `<div>最新数据: ${data.summary.latest_date}</div><div>更新时间: ${ALL_DATA.updated_at}</div>`;

      // 更新所有图表标题，加入品种标识
      const tag = `${data.name_en} ${data.name}`;
      document.getElementById('title-combo').textContent     = `${tag} - 净持仓趋势与边际变化`;
      document.getElementById('title-change').textContent    = `${tag} - Other Reportable 持仓周度变化`;
      document.getElementById('title-oi').textContent        = `${tag} - 未平仓合约量`;
      document.getElementById('title-compare').textContent   = `${tag} - 管理基金多空持仓对比（近12周）`;
      document.getElementById('title-table').textContent     = `${tag} - 周度持仓变化明细`;
      document.getElementById('title-gvz-combo').textContent = `${tag} - GVZ 波动率 vs 管理基金净持仓`;
      document.getElementById('title-gvz').textContent       = `${tag} - GVZ 黄金波动率指数`;
    }

    function renderMetrics(s) {
      const cards = [
        { label: '管理基金净持仓', value: s.mm_net, change: s.mm_net_change, pct: s.mm_pct_change },
        { label: '生产商净持仓', value: s.prod_net, change: s.prod_net_change, pct: s.prod_pct_change },
        { label: '未平仓合约', value: s.open_interest, change: s.oi_change },
        { label: '多空比(MM)', value: s.long_short_ratio, isRatio: true }
      ];
      document.getElementById('metrics').innerHTML = cards.map(c => {
        const vClass = c.isRatio ? '' : c.value > 0 ? ' positive' : c.value < 0 ? ' negative' : '';
        const cClass = c.change > 0 ? ' positive' : c.change < 0 ? ' negative' : '';
        const pctText = c.pct !== undefined ? ` (${fmtPct(c.pct)})` : '';
        return `<div class="metric-card">
          <div class="metric-label">${c.label}</div>
          <div class="metric-value${vClass}">${c.isRatio ? c.value : fmt(c.value)}</div>
          ${c.change !== undefined ? `<div class="metric-change${cClass}">周变化: ${fmtChg(c.change)}${pctText}</div>` : ''}
        </div>`;
      }).join('');
    }

    function renderCharts(weeklyData) {
      const labels = weeklyData.map(d => d.date.slice(5));
      Object.values(charts).forEach(c => c.destroy());
      charts = {};

      // 组合图：净持仓趋势 + 边际变化
      const mmChanges = weeklyData.map(d => d.mm_net_change);
      charts.combo = new Chart(document.getElementById('comboChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: '管理基金净持仓',
              data: weeklyData.map(d => d.mm_net),
              borderColor: '#D4AF37',
              backgroundColor: 'rgba(212,175,55,0.1)',
              tension: 0.3,
              yAxisID: 'y',
              order: 1
            },
            {
              label: '生产商净持仓',
              data: weeklyData.map(d => d.prod_net),
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59,130,246,0.1)',
              tension: 0.3,
              yAxisID: 'y',
              order: 2
            },
            {
              label: '管理基金周变化',
              data: mmChanges,
              type: 'bar',
              backgroundColor: mmChanges.map(v => v >= 0 ? 'rgba(34,197,94,0.6)' : 'rgba(239,68,68,0.6)'),
              borderColor: mmChanges.map(v => v >= 0 ? '#22c55e' : '#ef4444'),
              borderWidth: 1,
              yAxisID: 'y1',
              order: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y: { type: 'linear', position: 'left', ticks: { callback: fmtAxis } },
            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: fmtAxis } }
          }
        }
      });

      // Other Reportable 净持仓变化 + 均值线
      const otherNetChanges = weeklyData.map(d => d.other_net_change ?? 0);
      const sortedOtherNet = [...otherNetChanges].sort((a, b) => a - b);
      const midON = Math.floor(sortedOtherNet.length / 2);
      const medianOtherNet = sortedOtherNet.length % 2 === 0
        ? (sortedOtherNet[midON - 1] + sortedOtherNet[midON]) / 2
        : sortedOtherNet[midON];
      charts.change = new Chart(document.getElementById('changeChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '净持仓变化',
              data: otherNetChanges,
              backgroundColor: otherNetChanges.map(v => v >= 0 ? 'rgba(212,175,55,0.7)' : 'rgba(239,68,68,0.7)'),
              borderColor: otherNetChanges.map(v => v >= 0 ? '#D4AF37' : '#ef4444'),
              borderWidth: 1
            },
            {
              label: '中位数 ' + fmtAxis(Math.round(medianOtherNet)),
              data: Array(labels.length).fill(medianOtherNet),
              type: 'line',
              borderColor: '#888',
              borderDash: [5, 5],
              borderWidth: 2,
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { ticks: { callback: fmtAxis } } }
        }
      });

      // 未平仓合约
      const oiData = weeklyData.map(d => d.open_interest);
      const avgOI = oiData.reduce((a,b) => a+b, 0) / oiData.length;
      // 计算中位数
      const sortedOI = [...oiData].sort((a, b) => a - b);
      const midIdx = Math.floor(sortedOI.length / 2);
      const medianOI = sortedOI.length % 2 === 0 ? (sortedOI[midIdx - 1] + sortedOI[midIdx]) / 2 : sortedOI[midIdx];
      charts.oi = new Chart(document.getElementById('oiChart'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: '未平仓合约', data: oiData, backgroundColor: oiData.map(v => v >= medianOI ? '#FFD700' : '#5c4a1f'), order: 2 },
            { label: '中位数 ' + fmtAxis(medianOI), data: Array(labels.length).fill(medianOI), type: 'line', borderColor: '#ef4444', borderDash: [8, 4], borderWidth: 3, pointRadius: 0, fill: false, order: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { ticks: { callback: fmtAxis } } }
        }
      });

      // 多空对比
      const recent = weeklyData.slice(-12);
      const recentLabels = recent.map(d => d.date.slice(5));

      // 计算近12周多头、空头中位数
      const calcMedian = arr => {
        const sorted = [...arr].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
      };
      const longData = recent.map(d => d.mm_long);
      const shortData = recent.map(d => d.mm_short);
      const medianLong = calcMedian(longData);
      const medianShort = calcMedian(shortData);

      charts.compare = new Chart(document.getElementById('compareChart'), {
        type: 'bar',
        data: {
          labels: recentLabels,
          datasets: [
            { label: '管理基金多头', data: longData, backgroundColor: longData.map(v => v >= medianLong ? '#22c55e' : '#1a3d2b'), order: 2 },
            { label: '管理基金空头', data: shortData, backgroundColor: shortData.map(v => v >= medianShort ? '#ef4444' : '#3d1a1a'), order: 2 },
            { label: '多头中位数 ' + fmtAxis(medianLong), data: Array(recentLabels.length).fill(medianLong), type: 'line', borderColor: '#22c55e', borderDash: [8, 4], borderWidth: 2, pointRadius: 0, fill: false, order: 1 },
            { label: '空头中位数 ' + fmtAxis(medianShort), data: Array(recentLabels.length).fill(medianShort), type: 'line', borderColor: '#ef4444', borderDash: [8, 4], borderWidth: 2, pointRadius: 0, fill: false, order: 1 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { y: { ticks: { callback: fmtAxis } } }
        }
      });
    }

    function renderGVZ(weeklyData) {
      const isGold = currentCommodity === 'gold' || currentCommodity === 'micro_gold';
      document.getElementById('gvzComboCard').style.display = isGold ? '' : 'none';
      document.getElementById('gvzCard').style.display = isGold ? '' : 'none';
      if (!isGold || !ALL_DATA.gvz || !ALL_DATA.gvz.length) return;

      // 将 GVZ 按 COT 日期对齐（取最近一个周二的值）
      const gvzMap = {};
      ALL_DATA.gvz.forEach(d => { gvzMap[d.date] = d.close; });

      const gldVolMap = {};
      ALL_DATA.gvz.forEach(d => { if (d.gld_volume != null) gldVolMap[d.date] = d.gld_volume; });

      const aligned = weeklyData.map(d => ({
        date: d.date.slice(5),
        mm_net: d.mm_net,
        gvz: gvzMap[d.date] ?? null,
        gld_volume: gldVolMap[d.date] ?? null
      }));

      const gvzValues = aligned.map(d => d.gvz).filter(v => v !== null);
      const avgGVZ = gvzValues.reduce((a, b) => a + b, 0) / gvzValues.length;
      const sortedGVZ = [...gvzValues].sort((a, b) => a - b);
      const mid = Math.floor(sortedGVZ.length / 2);
      const medianGVZ = sortedGVZ.length % 2 === 0 ? (sortedGVZ[mid - 1] + sortedGVZ[mid]) / 2 : sortedGVZ[mid];

      const gldVolValues = aligned.map(d => d.gld_volume).filter(v => v !== null);
      const sortedVol = [...gldVolValues].sort((a, b) => a - b);
      const midV = Math.floor(sortedVol.length / 2);
      const medianGldVol = sortedVol.length % 2 === 0 ? (sortedVol[midV - 1] + sortedVol[midV]) / 2 : sortedVol[midV];
      const avgGldVol = gldVolValues.length ? gldVolValues.reduce((a, b) => a + b, 0) / gldVolValues.length : 0;

      if (charts.gvzCombo) charts.gvzCombo.destroy();
      if (charts.gvz) charts.gvz.destroy();

      // 图1：GVZ vs 净持仓双轴
      charts.gvzCombo = new Chart(document.getElementById('gvzComboChart'), {
        type: 'line',
        data: {
          labels: aligned.map(d => d.date),
          datasets: [
            {
              label: '管理基金净持仓',
              data: aligned.map(d => d.mm_net),
              borderColor: '#D4AF37',
              backgroundColor: 'rgba(212,175,55,0.1)',
              tension: 0.3,
              yAxisID: 'y',
              order: 1
            },
            {
              label: 'GVZ 波动率',
              data: aligned.map(d => d.gvz),
              borderColor: '#a78bfa',
              backgroundColor: 'rgba(167,139,250,0.1)',
              tension: 0.3,
              yAxisID: 'y1',
              order: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y:  { type: 'linear', position: 'left',  ticks: { callback: fmtAxis } },
            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: v => v.toFixed(1) } }
          }
        }
      });

      // 图2：GVZ 独立走势 + GLD 成交量
      charts.gvz = new Chart(document.getElementById('gvzChart'), {
        type: 'line',
        data: {
          labels: aligned.map(d => d.date),
          datasets: [
            {
              label: 'GLD 周成交量',
              data: aligned.map(d => d.gld_volume),
              type: 'bar',
              backgroundColor: aligned.map(d => d.gld_volume != null ? (d.gld_volume >= avgGldVol ? '#D4AF37' : '#3a2f10') : 'transparent'),
              borderColor: aligned.map(d => d.gld_volume != null ? (d.gld_volume >= avgGldVol ? '#D4AF37' : '#3a2f10') : 'transparent'),
              borderWidth: 1,
              yAxisID: 'y1',
              order: 3
            },
            {
              label: 'GVZ',
              data: aligned.map(d => d.gvz),
              borderColor: '#6644aa',
              backgroundColor: 'rgba(167,139,250,0.05)',
              tension: 0.3,
              fill: false,
              pointRadius: 2,
              pointBackgroundColor: aligned.map(d => d.gvz != null ? (d.gvz >= avgGVZ ? '#a78bfa' : '#6644aa') : 'transparent'),
              segment: {
                borderColor: ctx => ctx.p1.parsed.y >= avgGVZ ? '#a78bfa' : '#6644aa'
              },
              yAxisID: 'y',
              order: 1
            },
            {
              label: '均值 ' + avgGVZ.toFixed(1),
              data: Array(aligned.length).fill(parseFloat(avgGVZ.toFixed(2))),
              borderColor: '#888',
              borderDash: [6, 4],
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              yAxisID: 'y',
              order: 2
            },
            {
              label: 'GLD周成交量-中位数-' + fmtAxis(medianGldVol),
              data: Array(aligned.length).fill(medianGldVol),
              type: 'line',
              borderColor: '#f59e0b',
              borderDash: [6, 4],
              borderWidth: 2,
              pointRadius: 0,
              fill: false,
              yAxisID: 'y1',
              order: 2
            },
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y:  { type: 'linear', position: 'left',  ticks: { callback: v => v.toFixed(1) } },
            y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: fmtAxis } }
          }
        }
      });
    }

    function renderTable(weeklyData) {
      const rows = [...weeklyData].reverse();
      document.getElementById('dataTable').innerHTML = `
        <thead><tr>
          <th>日期</th>
          <th class="num">管理基金净持仓</th><th class="num">周变化</th><th class="num">变化率</th>
          <th class="num">生产商净持仓</th><th class="num">周变化</th>
          <th class="num">未平仓合约</th><th class="num">周变化</th>
        </tr></thead>
        <tbody>${rows.map((r, i) => {
          const prev = i < rows.length - 1 ? rows[i + 1] : r;
          const pctChg = prev.mm_net !== 0 ? ((r.mm_net - prev.mm_net) / Math.abs(prev.mm_net)) * 100 : 0;
          return `<tr>
            <td>${r.date}</td>
            <td class="num">${fmt(r.mm_net)}</td>
            <td class="num ${r.mm_net_change > 0 ? 'pos' : r.mm_net_change < 0 ? 'neg' : ''}">${fmtChg(r.mm_net_change)}</td>
            <td class="num ${pctChg > 0 ? 'pos' : pctChg < 0 ? 'neg' : ''}">${fmtPct(pctChg)}</td>
            <td class="num">${fmt(r.prod_net)}</td>
            <td class="num ${r.prod_net_change > 0 ? 'pos' : r.prod_net_change < 0 ? 'neg' : ''}">${fmtChg(r.prod_net_change)}</td>
            <td class="num">${fmt(r.open_interest)}</td>
            <td class="num ${r.oi_change > 0 ? 'pos' : r.oi_change < 0 ? 'neg' : ''}">${fmtChg(r.oi_change)}</td>
          </tr>`;
        }).join('')}</tbody>`;
    }

    const FALLBACK_DATA = {
      "commodity_list": [{"code": "gold", "name": "黄金", "name_en": "GOLD (COMEX)"}],
      "commodities": {
        "gold": {
          "name": "黄金", "name_en": "GOLD (COMEX)",
          "summary": {"latest_date": "2026-02-10", "mm_net": 160012, "prod_net": -197738, "open_interest": 404391, "mm_net_change": -5592, "prod_net_change": 10040, "oi_change": -5303, "long_short_ratio": 4.03},
          "weekly_data": [
            {"date": "2025-11-18", "mm_long": 269556, "mm_short": 59217, "open_interest": 471953, "mm_net": 210339, "prod_net": -245585, "mm_net_change": 0, "prod_net_change": 0, "oi_change": 0},
            {"date": "2025-11-25", "mm_long": 253266, "mm_short": 48678, "open_interest": 432946, "mm_net": 204588, "prod_net": -241403, "mm_net_change": -5751, "prod_net_change": 4182, "oi_change": -39007},
            {"date": "2025-12-02", "mm_long": 261331, "mm_short": 43771, "open_interest": 418490, "mm_net": 217560, "prod_net": -255348, "mm_net_change": 12972, "prod_net_change": -13945, "oi_change": -14456},
            {"date": "2025-12-09", "mm_long": 268485, "mm_short": 44599, "open_interest": 432569, "mm_net": 223886, "prod_net": -262579, "mm_net_change": 6326, "prod_net_change": -7231, "oi_change": 14079},
            {"date": "2025-12-16", "mm_long": 280920, "mm_short": 46942, "open_interest": 471093, "mm_net": 233978, "prod_net": -274358, "mm_net_change": 10092, "prod_net_change": -11779, "oi_change": 38524},
            {"date": "2025-12-23", "mm_long": 290161, "mm_short": 49461, "open_interest": 492103, "mm_net": 240700, "prod_net": -283526, "mm_net_change": 6722, "prod_net_change": -9168, "oi_change": 21010},
            {"date": "2025-12-30", "mm_long": 275592, "mm_short": 44419, "open_interest": 481866, "mm_net": 231173, "prod_net": -275246, "mm_net_change": -9527, "prod_net_change": 8280, "oi_change": -10237},
            {"date": "2026-01-06", "mm_long": 274435, "mm_short": 46803, "open_interest": 488116, "mm_net": 227632, "prod_net": -272035, "mm_net_change": -3541, "prod_net_change": 3211, "oi_change": 6250},
            {"date": "2026-01-13", "mm_long": 296183, "mm_short": 44945, "open_interest": 527455, "mm_net": 251238, "prod_net": -297106, "mm_net_change": 23606, "prod_net_change": -25071, "oi_change": 39339},
            {"date": "2026-01-20", "mm_long": 295772, "mm_short": 51002, "open_interest": 528004, "mm_net": 244770, "prod_net": -289689, "mm_net_change": -6468, "prod_net_change": 7417, "oi_change": 549},
            {"date": "2026-01-27", "mm_long": 252100, "mm_short": 46704, "open_interest": 488463, "mm_net": 205396, "prod_net": -248285, "mm_net_change": -39374, "prod_net_change": 41404, "oi_change": -39541},
            {"date": "2026-02-03", "mm_long": 214508, "mm_short": 48904, "open_interest": 409694, "mm_net": 165604, "prod_net": -207778, "mm_net_change": -39792, "prod_net_change": 40507, "oi_change": -78769},
            {"date": "2026-02-10", "mm_long": 212808, "mm_short": 52796, "open_interest": 404391, "mm_net": 160012, "prod_net": -197738, "mm_net_change": -5592, "prod_net_change": 10040, "oi_change": -5303}
          ]
        }
      },
      "updated_at": "2026-02-15"
    };

    loadData();
  </script>
</body>
</html>
